#!/bin/bash
# Extract High Priority PR Files for Review
# Save as: ~/bin/extract-pr-files

PR_BRANCH="${1:-pr-3454}"
BASE_BRANCH="${2:-master}"
OUTPUT_DIR="pr-${PR_BRANCH}-review"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘      Extracting High Priority Files from PR #${PR_BRANCH}      â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Create output directory
mkdir -p "$OUTPUT_DIR"/{new-files,modified-files,diffs}

# High priority files to extract
HIGH_PRIORITY_FILES=(
  "bin/omarchy-gpu-passthrough"
  "bin/omarchy-gpu-passthrough-bind"
  "bin/omarchy-gpu-passthrough-utils"
  "bin/omarchy-gpu-passthrough-setup"
  "bin/omarchy-gpu-passthrough-info"
  "bin/omarchy-looking-glass-launch"
  "bin/omarchy-looking-glass-install"
  "install/config/hardware/nvidia.sh"
  "bin/omarchy-windows-vm"
)

echo -e "${BLUE}ğŸ“ Output directory: ${OUTPUT_DIR}/${NC}"
echo

# Checkout PR branch temporarily
CURRENT_BRANCH=$(git branch --show-current)
echo -e "${YELLOW}ğŸ”„ Switching to ${PR_BRANCH}...${NC}"
git checkout "$PR_BRANCH" 2>/dev/null || {
  echo -e "${RED}âŒ Failed to checkout ${PR_BRANCH}${NC}"
  exit 1
}

# Extract each file
for file in "${HIGH_PRIORITY_FILES[@]}"; do
  filename=$(basename "$file")

  # Check if file exists in PR branch
  if [[ -f "$file" ]]; then
    # Get file status
    status=$(git diff --name-status "$BASE_BRANCH".."$PR_BRANCH" -- "$file" 2>/dev/null | cut -f1)

    if [[ $status == "A" ]]; then
      # New file - copy it
      echo -e "${GREEN}[+] NEW:${NC} $filename"
      cp "$file" "$OUTPUT_DIR/new-files/$filename"

      # Get line count
      lines=$(wc -l < "$file")
      echo "    ğŸ“Š Lines: $lines"

    elif [[ $status == "M" ]]; then
      # Modified file - copy new version and create diff
      echo -e "${YELLOW}[~] MODIFIED:${NC} $filename"
      cp "$file" "$OUTPUT_DIR/modified-files/$filename"

      # Create diff file
      git diff "$BASE_BRANCH".."$PR_BRANCH" -- "$file" > "$OUTPUT_DIR/diffs/$filename.diff"

      # Get change stats
      stats=$(git diff --numstat "$BASE_BRANCH".."$PR_BRANCH" -- "$file" | awk '{print "+", $1, " -", $2}')
      echo "    ğŸ“Š Changes: $stats"
    fi

    # Get file type info
    file_type=$(file -b "$file" | cut -d',' -f1)
    echo "    ğŸ“ Type: $file_type"
    echo
  else
    echo -e "${RED}[!] NOT FOUND:${NC} $file"
    echo
  fi
done

# Switch back to original branch
echo -e "${YELLOW}ğŸ”„ Switching back to ${CURRENT_BRANCH}...${NC}"
git checkout "$CURRENT_BRANCH" 2>/dev/null

echo
echo -e "${GREEN}âœ… Extraction complete!${NC}"
echo
echo -e "${BLUE}ğŸ“‚ Review structure:${NC}"
echo "  $OUTPUT_DIR/"
echo "  â”œâ”€â”€ new-files/          # Brand new scripts (9 files)"
echo "  â”œâ”€â”€ modified-files/     # Updated scripts (with current state)"
echo "  â””â”€â”€ diffs/              # Diff files showing what changed"
echo
echo -e "${BLUE}ğŸ“– Quick review commands:${NC}"
echo "  # View all new GPU scripts"
echo "  ls -lh $OUTPUT_DIR/new-files/"
echo
echo "  # Read a specific new file"
echo "  nvim $OUTPUT_DIR/new-files/omarchy-gpu-passthrough-setup"
echo
echo "  # Review what changed in nvidia.sh"
echo "  nvim $OUTPUT_DIR/diffs/nvidia.sh.diff"
echo
echo "  # Browse all files interactively"
echo "  cd $OUTPUT_DIR && ranger"
echo
echo -e "${BLUE}ğŸ” Quick analysis:${NC}"
echo "  # Count lines in all new files"
echo "  wc -l $OUTPUT_DIR/new-files/* | sort -n"
echo
echo "  # Search for RTX 4070 references"
echo "  grep -r '4070\|Ada\|89\|sm_89' $OUTPUT_DIR/"
echo
echo "  # Find VFIO references"
echo "  grep -r 'vfio\|VFIO' $OUTPUT_DIR/new-files/"
echo

# Generate quick reference document
cat > "$OUTPUT_DIR/README.md" << EOF
# PR #${PR_BRANCH} High Priority Files Review

Generated: $(date)

## Summary

This directory contains the high-priority GPU-related files from PR #${PR_BRANCH}.

### New Files (GPU Passthrough Feature)
EOF

for file in "$OUTPUT_DIR/new-files"/*; do
  if [[ -f "$file" ]]; then
    filename=$(basename "$file")
    lines=$(wc -l < "$file" 2>/dev/null || echo "0")

    # Get description
    case $filename in
      omarchy-gpu-passthrough-setup)
        desc="Initial GPU passthrough setup - configures IOMMU, VFIO drivers"
        ;;
      omarchy-gpu-passthrough-bind)
        desc="Binds RTX 4070 to VFIO driver for VM passthrough"
        ;;
      omarchy-gpu-passthrough-info)
        desc="Displays GPU passthrough configuration and status"
        ;;
      omarchy-gpu-passthrough-utils)
        desc="Utility functions for GPU passthrough management"
        ;;
      omarchy-gpu-passthrough)
        desc="Main orchestrator for GPU passthrough operations"
        ;;
      omarchy-looking-glass-install)
        desc="Installs Looking Glass for low-latency VM display sharing"
        ;;
      omarchy-looking-glass-launch)
        desc="Launches Looking Glass client for VM display"
        ;;
      *)
        desc="GPU passthrough related utility"
        ;;
    esac

    echo "- **$filename** ($lines lines) - $desc" >> "$OUTPUT_DIR/README.md"
  fi
done

cat >> "$OUTPUT_DIR/README.md" << EOF

### Modified Files
- **nvidia.sh** - NVIDIA driver configuration updates (+65/-25 lines)
- **omarchy-windows-vm** - Windows VM management script updates (+3736/-296 lines)

## Review Priority

### ğŸ”¥ Critical (Review First)
1. \`new-files/omarchy-gpu-passthrough-setup\` - Sets up your RTX 4070 for passthrough
2. \`new-files/omarchy-gpu-passthrough-bind\` - Actually binds the GPU to VFIO
3. \`diffs/nvidia.sh.diff\` - See what changed in NVIDIA config

### âš¡ Important
4. \`new-files/omarchy-looking-glass-install\` - Looking Glass setup
5. \`new-files/omarchy-gpu-passthrough-info\` - Diagnostic information
6. \`modified-files/omarchy-windows-vm\` - Updated VM manager

### ğŸ“¦ Supporting
7. \`new-files/omarchy-gpu-passthrough-utils\` - Helper functions
8. \`new-files/omarchy-gpu-passthrough\` - Main script
9. \`new-files/omarchy-looking-glass-launch\` - Looking Glass launcher

## Key Questions to Answer During Review

1. **IOMMU Groups**: Does the setup properly handle your RTX 4070's IOMMU group?
2. **Driver Binding**: Is the VFIO binding script compatible with nvidia-open-dkms?
3. **Looking Glass**: Does it detect your system specs correctly?
4. **NVIDIA Changes**: What changed in the NVIDIA driver config and why?

## Commands

\`\`\`bash
# Search for your GPU architecture (Ada/sm_89)
grep -rn "89\|Ada\|4070" new-files/

# Check VFIO references
grep -rn "vfio" new-files/

# Find modprobe configurations
grep -rn "modprobe\|modules" new-files/

# Look for kernel parameters
grep -rn "grub\|cmdline\|intel_iommu\|iommu" new-files/
\`\`\`

## Next Steps

After review:
1. Test the setup script in a VM or backup your system
2. Check if it conflicts with your current nvidia-open-dkms setup
3. Verify Looking Glass version compatibility
4. Review Windows VM configuration for optimal RTX 4070 performance
EOF

echo -e "${GREEN}ğŸ“„ Generated README: $OUTPUT_DIR/README.md${NC}"
echo

# Create a quick grep helper
cat > "$OUTPUT_DIR/search.sh" << 'EOF'
#!/bin/bash
# Quick search helper for PR review files

QUERY="$1"
if [[ -z "$QUERY" ]]; then
  echo "Usage: ./search.sh <search_term>"
  echo "Examples:"
  echo "  ./search.sh 'RTX 4070'"
  echo "  ./search.sh 'vfio'"
  echo "  ./search.sh 'iommu'"
  exit 1
fi

echo "Searching for: $QUERY"
echo
grep -rn --color=always "$QUERY" new-files/ modified-files/
EOF

chmod +x "$OUTPUT_DIR/search.sh"
echo -e "${GREEN}ğŸ” Search helper: $OUTPUT_DIR/search.sh${NC}"
echo

# Create an analysis script
cat > "$OUTPUT_DIR/analyze.sh" << 'EOF'
#!/bin/bash
# Analyze GPU passthrough scripts

echo "=== GPU Passthrough PR Analysis ==="
echo

echo "ğŸ“Š File Statistics:"
echo "  New files:"
wc -l new-files/* 2>/dev/null | tail -1 | awk '{print "    Total lines: " $1}'
echo "  Modified files:"
wc -l modified-files/* 2>/dev/null | tail -1 | awk '{print "    Total lines: " $1}'
echo

echo "ğŸ” Key References:"
echo "  VFIO mentions:"
grep -c "vfio" new-files/* 2>/dev/null | grep -v ":0$" || echo "    None found"
echo
echo "  IOMMU mentions:"
grep -c "iommu" new-files/* 2>/dev/null | grep -v ":0$" || echo "    None found"
echo
echo "  Looking Glass mentions:"
grep -c "looking.glass\|looking_glass\|LookingGlass" new-files/* 2>/dev/null | grep -v ":0$" || echo "    None found"
echo
echo "  GPU mentions:"
grep -c -i "gpu\|nvidia\|rtx" new-files/* 2>/dev/null | grep -v ":0$" || echo "    None found"
echo

echo "âš ï¸  Potential Issues to Check:"
echo "  Hardcoded paths:"
grep -n "/usr/local\|/opt" new-files/* 2>/dev/null | head -5
echo
echo "  Root requirements:"
grep -n "sudo\|root" new-files/* 2>/dev/null | head -5
echo
EOF

chmod +x "$OUTPUT_DIR/analyze.sh"
echo -e "${GREEN}ğŸ“ˆ Analysis script: $OUTPUT_DIR/analyze.sh${NC}"
echo

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ¨ All done! Start reviewing with:${NC}"
echo -e "   ${YELLOW}cd $OUTPUT_DIR && nvim README.md${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

