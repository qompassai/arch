#!/bin/bash
# omarchy-looking-glass-install - Install Looking Glass client for VM display

# Preserve original script arguments for exec sg kvm (group refresh)
ORIGINAL_SCRIPT_ARGS=("$@")

SPICE_DIR="/var/run/omarchy-windows"      # SPICE socket directory (tmpfs, auto-cleaned on reboot)
SPICE_SOCKET_PATH="$SPICE_DIR/spice.sock" # SPICE Unix socket

msg_error() {
  echo "❌  Error: $*" >&2
}

msg_warning() {
  echo "⚠️  Warning: $*" >&2
}

msg_success() {
  echo "✓  $*"
}

msg_info() {
  echo "ℹ️  $*"
}

format_escape_key_name() {
  case "$1" in
    KEY_SCROLLLOCK) echo "Scroll Lock" ;;
    KEY_RIGHTCTRL)  echo "Right Ctrl" ;;
    KEY_LEFTCTRL)   echo "Left Ctrl" ;;
    KEY_RIGHTALT)   echo "Right Alt" ;;
    KEY_PAUSE)      echo "Pause" ;;
    KEY_INSERT)     echo "Insert" ;;
    *) echo "${1#KEY_}" ;;
  esac
}

create_tmpfiles_config() {
  local tmpfiles_config_file="/etc/tmpfiles.d/omarchy-windows.conf"

  msg_info "Configuring SPICE directory auto-creation..."

  sudo tee "$tmpfiles_config_file" >/dev/null <<'EOF'
# Omarchy Windows VM - SPICE socket directory
# Auto-created on boot by systemd-tmpfiles
# Directory created in /var/run (tmpfs, cleared on reboot)
d /var/run/omarchy-windows 0770 root kvm - -
EOF

  if sudo systemd-tmpfiles --create "$tmpfiles_config_file" 2>/dev/null; then
    msg_success "SPICE directory tmpfiles configured"

    if [[ -d "$SPICE_DIR" ]]; then
      local perms=$(stat -c "%a" "$SPICE_DIR" 2>/dev/null)
      local owner=$(stat -c "%U:%G" "$SPICE_DIR" 2>/dev/null)
      if [[ "$perms" == "770" ]] && [[ "$owner" == "root:kvm" ]]; then
        msg_success "SPICE directory ready: $SPICE_DIR"
      else
        msg_warning "SPICE directory created but permissions may be incorrect"
        msg_info "  Expected: 770 root:kvm, Got: $perms $owner"
      fi
    else
      msg_warning "SPICE directory not created (will be created on next boot)"
    fi
  else
    msg_warning "Failed to apply tmpfiles configuration (will be created on next boot)"
  fi

  return 0
}

create_sudoers_config() {
  local sudoers_file="/etc/sudoers.d/omarchy-looking-glass"

  local sudoers_content="# Omarchy Looking Glass - Passwordless Operations
# Generated by omarchy-looking-glass-install

# SPICE socket detection and permissions
$USER ALL=(ALL) NOPASSWD: /usr/bin/test -S /var/run/omarchy-windows/spice.sock
$USER ALL=(ALL) NOPASSWD: /usr/bin/chmod 660 /var/run/omarchy-windows/spice.sock
$USER ALL=(ALL) NOPASSWD: /usr/bin/chgrp kvm /var/run/omarchy-windows/spice.sock

# SPICE directory creation (fallback if tmpfiles.d fails)
$USER ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /var/run/omarchy-windows

# KVMFR module (Looking Glass shared memory)
$USER ALL=(ALL) NOPASSWD: /usr/bin/modprobe kvmfr, /usr/bin/modprobe kvmfr static_size_mb=*
"

  local temp_file=$(mktemp)
  echo "$sudoers_content" > "$temp_file"

  if ! sudo visudo -c -f "$temp_file" 2>&1 | grep -q "parsed OK"; then
    msg_error "Sudoers syntax validation failed!"
    echo ""
    echo "Generated content (for debugging):"
    cat "$temp_file"
    echo ""
    rm -f "$temp_file"
    return 1
  fi

  msg_success "Sudoers syntax validated"

  if sudo install -m 440 -o root -g root "$temp_file" "$sudoers_file"; then
    msg_success "Sudoers rules installed: $sudoers_file"

    if sudo visudo -c 2>&1 | grep -q "parsed OK"; then
      msg_success "Overall sudoers configuration OK"
    else
      msg_error "Overall sudoers check failed!"
      echo "   This may indicate a conflict with existing sudoers rules"
      echo "   Check with: sudo visudo -c"
      sudo rm -f "$sudoers_file"
      rm -f "$temp_file"
      return 1
    fi

  else
    msg_error "Failed to install sudoers rules"
    rm -f "$temp_file"
    return 1
  fi

  rm -f "$temp_file"
  return 0
}

echo "Installing Looking Glass B7..."
echo "Ultra-low latency VM display as an alternative to RDP."
echo ""

if ! sudo -v 2>/dev/null; then
  msg_error "sudo access required for installation"
  exit 1
fi

# Check Secure Boot (may block unsigned DKMS modules)
if command -v mokutil &>/dev/null; then
  if mokutil --sb-state 2>/dev/null | grep -qi "enabled"; then
    msg_warning "Secure Boot is ENABLED"
    echo "   DKMS modules (like kvmfr) may fail to load with Secure Boot."
    echo "   If installation fails, disable Secure Boot in BIOS settings."
    echo ""
  fi
fi

# Install kernel headers (required for DKMS)
msg_info "Installing kernel headers..."
KERNEL=$(uname -r)

# Detect kernel package
if [[ ! -d "/lib/modules/$KERNEL" ]]; then
  KERNEL_PACKAGE="linux"
else
  KERNEL_PACKAGE=$(pacman -Qo "/lib/modules/$KERNEL" 2>/dev/null | sed -n 's/.* is owned by \([^ ]*\) .*/\1/p' | head -1)
  [[ -z "$KERNEL_PACKAGE" ]] && KERNEL_PACKAGE="linux"
fi

# Determine headers package
case "$KERNEL_PACKAGE" in
  linux)     HEADERS_PKG="linux-headers" ;;
  linux-lts) HEADERS_PKG="linux-lts-headers" ;;
  linux-zen) HEADERS_PKG="linux-zen-headers" ;;
  *)         HEADERS_PKG="linux-headers" ;;
esac

# Install quietly
HEADERS_LOG="/tmp/headers-install-$$.log"
if ! omarchy-pkg-add "$HEADERS_PKG" > "$HEADERS_LOG" 2>&1; then
  msg_error "Failed to install $HEADERS_PKG"
  tail -10 "$HEADERS_LOG"
  rm -f "$HEADERS_LOG"
  exit 1
fi
rm -f "$HEADERS_LOG"
msg_success "Kernel headers installed"

if pacman -Q looking-glass looking-glass-module-dkms &>/dev/null; then
  msg_success "Looking Glass packages already installed"
else
  msg_info "Installing packages (looking-glass, looking-glass-module-dkms)..."
  echo "   This may take a few minutes (downloading and compiling)..."

  LG_LOG_FILE="/tmp/looking-glass-install-$$.log"

  # Run yay in background, capture output to log
  yay -S --noconfirm --needed --removemake --answerdiff=None --cleanafter looking-glass looking-glass-module-dkms > "$LG_LOG_FILE" 2>&1 &
  LG_YAY_PID=$!

  # Spinner while building
  LG_SPINNER=('⠋' '⠙' '⠹' '⠸' '⠼' '⠴' '⠦' '⠧' '⠇' '⠏')
  LG_SPIN_IDX=0
  while kill -0 $LG_YAY_PID 2>/dev/null; do
    printf "\r  Building... %s " "${LG_SPINNER[$LG_SPIN_IDX]}"
    LG_SPIN_IDX=$(( (LG_SPIN_IDX+1) % ${#LG_SPINNER[@]} ))
    sleep 0.1
  done
  printf "\r                    \r"

  wait $LG_YAY_PID
  LG_EXIT_CODE=$?

  if [[ $LG_EXIT_CODE -ne 0 ]]; then
    echo ""
    msg_error "Failed to install Looking Glass packages"
    echo ""
    echo "Last 30 lines of build log:"
    echo "─────────────────────────────────────────"
    tail -30 "$LG_LOG_FILE"
    echo "─────────────────────────────────────────"
    echo ""
    echo "Full log: $LG_LOG_FILE"
    exit 1
  fi

  rm -f "$LG_LOG_FILE"
  msg_success "Packages installed"
fi

# Verify DKMS actually built the module (always check, even if packages were pre-installed)
msg_info "Verifying DKMS module build..."
dkms_status=$(dkms status 2>/dev/null | grep -i looking-glass || echo "")

if [[ -z "$dkms_status" ]]; then
  msg_error "DKMS module not found!"
  echo "   The package is installed but DKMS failed to build the kernel module."
  echo ""
  echo "   Common causes:"
  echo "   - Kernel headers not installed for current kernel"
  echo "   - Non-standard kernel without DKMS support"
  echo "   - Secure Boot blocking unsigned modules"
  echo ""
  echo "   Check: dkms status"
  echo "   Check: pacman -Q linux-headers (or linux-zen-headers, etc.)"
  exit 1
fi

if ! echo "$dkms_status" | grep -qi "installed"; then
  msg_warning "DKMS module may not be properly installed"
  echo "   Status: $dkms_status"
else
  msg_success "DKMS module built: $dkms_status"
fi

# Verify module file exists
if ! modinfo kvmfr &>/dev/null; then
  msg_error "kvmfr module file not found!"
  echo "   DKMS reported success but module file doesn't exist."
  echo "   This may indicate a kernel mismatch."
  echo ""
  echo "   Your kernel: $(uname -r)"
  echo "   Installed headers: $(pacman -Q linux-headers 2>/dev/null || echo "not found")"
  echo ""
  echo "   Make sure kernel and headers match, then reinstall."
  exit 1
fi

# Configure udev rules
msg_info "Configuring udev rules..."
sudo tee /etc/udev/rules.d/99-kvmfr.rules >/dev/null <<'EOF'
SUBSYSTEM=="kvmfr", OWNER="root", GROUP="kvm", MODE="0660"
EOF

if ! sudo udevadm control --reload-rules 2>/dev/null; then
  msg_warning "Failed to reload udev rules (non-fatal)"
fi

if ! sudo udevadm trigger 2>/dev/null; then
  msg_warning "Failed to trigger udev (non-fatal)"
fi

msg_success "Udev rules configured"

IVSHMEM_SIZE_FROM_ENV="${IVSHMEM_SIZE:-}"

if [[ "${FORCE_RECONFIGURE:-0}" != "1" ]] && [[ -f /etc/modprobe.d/kvmfr.conf ]]; then
  IVSHMEM_SIZE=$(grep -oP 'static_size_mb=\K\d+' /etc/modprobe.d/kvmfr.conf 2>/dev/null || echo "")
  if [[ -n "$IVSHMEM_SIZE" ]]; then
    msg_success "Kernel module already configured (${IVSHMEM_SIZE}MB)"
  else
    sudo rm -f /etc/modprobe.d/kvmfr.conf
    IVSHMEM_SIZE=""
  fi
fi

if [[ -n "$IVSHMEM_SIZE_FROM_ENV" ]]; then
  IVSHMEM_SIZE="$IVSHMEM_SIZE_FROM_ENV"
  msg_success "Using ${IVSHMEM_SIZE}MB shared memory (from VM config)"

  # Update kvmfr.conf if size differs from current
  current_size=$(grep -oP 'static_size_mb=\K\d+' /etc/modprobe.d/kvmfr.conf 2>/dev/null || echo "0")
  if [[ "$current_size" != "$IVSHMEM_SIZE" ]]; then
    msg_info "Updating kernel module configuration (${current_size}MB → ${IVSHMEM_SIZE}MB)..."
    sudo tee /etc/modprobe.d/kvmfr.conf >/dev/null <<EOF
options kvmfr static_size_mb=$IVSHMEM_SIZE
EOF
  fi
fi

if [[ -z "$IVSHMEM_SIZE" ]] || { [[ "${FORCE_RECONFIGURE:-0}" == "1" ]] && [[ -z "$IVSHMEM_SIZE_FROM_ENV" ]]; }; then
  # Check available RAM before selection
  available_ram_mb=$(free -m | awk '/^Mem:/{print $7}')
  if [[ "$available_ram_mb" -lt 512 ]]; then
    echo ""
    msg_warning "Low available RAM: ${available_ram_mb}MB"
    echo "  IVSHMEM uses system RAM. Consider smaller size (32MB) or close applications."
  fi

  echo ""
  echo "Select Looking Glass shared memory size:"
  echo ""
  echo "  Resolution     Minimum   Recommended"
  echo "  1920×1080      32 MB     64 MB"
  echo "  2560×1440      64 MB     128 MB"
  echo "  3840×2160      128 MB    256 MB"
  echo ""
  echo "  Higher refresh rate (144Hz+) needs more memory."
  echo ""

  RESOLUTION_CHOICE=$(gum choose --selected="1080p (64MB) - recommended" \
    "1080p (32MB) - minimal, low RAM" \
    "1080p (64MB) - recommended" \
    "1440p (128MB)" \
    "4K (256MB)")

  if [[ -z "$RESOLUTION_CHOICE" ]]; then
    echo ""
    echo "Installation cancelled by user"
    exit 1
  fi

  case "$RESOLUTION_CHOICE" in
  *32MB*)
    IVSHMEM_SIZE=32
    RES_DISPLAY="1080p (minimal)"
    ;;
  *64MB*)
    IVSHMEM_SIZE=64
    RES_DISPLAY="1080p"
    ;;
  *128MB*)
    IVSHMEM_SIZE=128
    RES_DISPLAY="1440p"
    ;;
  *256MB*)
    IVSHMEM_SIZE=256
    RES_DISPLAY="4K"
    ;;
  *)
    IVSHMEM_SIZE=64
    RES_DISPLAY="1080p"
    ;;
  esac

  msg_success "Allocated ${IVSHMEM_SIZE}MB shared memory (sufficient for ${RES_DISPLAY} displays)"

  if ! [[ "$IVSHMEM_SIZE" =~ ^[0-9]+$ ]] || [[ "$IVSHMEM_SIZE" -lt 32 ]] || [[ "$IVSHMEM_SIZE" -gt 512 ]]; then
    msg_error "Invalid IVSHMEM_SIZE: $IVSHMEM_SIZE (must be 32-512)"
    exit 1
  fi

  msg_info "Writing kernel module configuration..."
  sudo tee /etc/modprobe.d/kvmfr.conf >/dev/null <<EOF
options kvmfr static_size_mb=$IVSHMEM_SIZE
EOF
fi

if [[ ! -f /etc/modules-load.d/kvmfr.conf ]]; then
  msg_info "Configuring kernel module auto-load..."
  echo "kvmfr" | sudo tee /etc/modules-load.d/kvmfr.conf >/dev/null
  msg_success "Kernel module auto-load configured"
fi

# Add user to kvm group
msg_info "Checking kvm group..."
ADDED_TO_KVM=false
if ! groups "$USER" | grep -q kvm; then
  sudo usermod -aG kvm "$USER"
  msg_success "Added to kvm group"
  echo ""
  msg_info "Refreshing group membership for current session..."
  echo ""
  exec sg kvm "$0" "${ORIGINAL_SCRIPT_ARGS[@]}"
else
  msg_success "Already in kvm group"
fi

LG_CONFIG="$HOME/.config/looking-glass/client.ini"
ESCAPE_KEY_FROM_ENV="${ESCAPE_KEY:-}"
ESCAPE_KEY=""
ESCAPE_KEY_SOURCE=""

# Check env override (highest priority)
if [[ -n "$ESCAPE_KEY_FROM_ENV" ]]; then
  ESCAPE_KEY="$ESCAPE_KEY_FROM_ENV"
  ESCAPE_KEY_SOURCE="env"
# Check existing config (if not forcing reconfigure)
elif [[ "${FORCE_RECONFIGURE:-0}" != "1" ]] && [[ -f "$LG_CONFIG" ]]; then
  ESCAPE_KEY=$(grep '^escapeKey=' "$LG_CONFIG" 2>/dev/null | cut -d= -f2 | head -1)
  [[ -n "$ESCAPE_KEY" ]] && ESCAPE_KEY_SOURCE="existing config"
fi

# Prompt user if no key set
if [[ -z "$ESCAPE_KEY" ]]; then
  IS_LAPTOP=false
  for bat in /sys/class/power_supply/BAT*; do
    [[ -d "$bat" ]] && IS_LAPTOP=true && break
  done

  if [[ "$IS_LAPTOP" == true ]]; then
    DEFAULT_KEY="KEY_RIGHTCTRL"
    DEFAULT_DESC="Right Ctrl (recommended for laptops)"
  else
    DEFAULT_KEY="KEY_SCROLLLOCK"
    DEFAULT_DESC="Scroll Lock (default)"
  fi

  echo ""
  echo "Select Looking Glass capture toggle key:"
  echo "  Press this key to toggle mouse/keyboard capture."
  echo "  When captured: mouse stays inside VM."
  echo "  Press again to release and use host desktop."
  echo ""

  ESCAPE_CHOICE=$(gum choose --selected="$DEFAULT_DESC" \
    "Scroll Lock (default)" \
    "Right Ctrl (recommended for laptops)" \
    "Right Alt" \
    "Pause" \
    "Insert")

  if [[ -z "$ESCAPE_CHOICE" ]]; then
    echo ""
    echo "Installation cancelled by user"
    exit 1
  fi

  case "$ESCAPE_CHOICE" in
    *"Scroll Lock"*)  ESCAPE_KEY="KEY_SCROLLLOCK" ;;
    *"Right Ctrl"*)   ESCAPE_KEY="KEY_RIGHTCTRL" ;;
    *"Right Alt"*)    ESCAPE_KEY="KEY_RIGHTALT" ;;
    *"Pause"*)        ESCAPE_KEY="KEY_PAUSE" ;;
    *"Insert"*)       ESCAPE_KEY="KEY_INSERT" ;;
    *)                ESCAPE_KEY="$DEFAULT_KEY" ;;
  esac
fi

if [[ -n "$ESCAPE_KEY_SOURCE" ]]; then
  msg_success "Capture toggle key: $(format_escape_key_name "$ESCAPE_KEY") (from $ESCAPE_KEY_SOURCE)"
else
  msg_success "Capture toggle key: $(format_escape_key_name "$ESCAPE_KEY")"
fi

# Create client configuration
if [[ "$ESCAPE_KEY_SOURCE" == "existing config" ]]; then
  msg_success "Using existing configuration (preserved)"
else
  msg_info "Creating client configuration..."
  mkdir -p "$HOME/.config/looking-glass"
  cat >"$LG_CONFIG" <<EOF
[app]
shmFile=/dev/kvmfr0

[input]
rawMouse=yes
autoCapture=no
captureOnly=no
escapeKey=$ESCAPE_KEY
grabKeyboard=yes
captureOnFocus=no

[win]
fullScreen=no
borderless=no

[spice]
enable=yes
host=$SPICE_SOCKET_PATH
port=0
input=yes
audio=yes
clipboard=yes
clipboardToVM=yes
clipboardToLocal=yes

[audio]
periodSize=256
bufferLatency=5
micDefault=allow
micShowIndicator=no
EOF
  msg_success "Configuration created with SPICE support ($LG_CONFIG)"
fi

create_tmpfiles_config
create_sudoers_config

msg_info "Installing desktop launcher..."
mkdir -p "$HOME/.local/share/applications"

cat >"$HOME/.local/share/applications/windows-looking-glass.desktop" <<DESKEOF
[Desktop Entry]
Name=Windows [Looking Glass]
Comment=Connect to Windows VM via Looking Glass (ultra-low latency)
Exec=uwsm-app -- omarchy-windows-vm launch --lg
Icon=$HOME/.local/share/applications/icons/windows.png
Terminal=false
Type=Application
Categories=System;Virtualization;
DESKEOF
msg_success "Desktop launcher installed"

msg_info "Loading kvmfr module..."
if lsmod | grep -q kvmfr; then
  if [[ ! -e /dev/kvmfr0 ]]; then
    echo "Module loaded but /dev/kvmfr0 missing - reloading with new config..."
    sudo -n rmmod kvmfr 2>/dev/null || true
    if sudo -n modprobe kvmfr static_size_mb="$IVSHMEM_SIZE" 2>/dev/null; then
      udevadm settle --timeout=5 2>/dev/null || sleep 1
      msg_success "Module reloaded"
    else
      msg_warning "Module reload failed (reboot required)"
    fi
  else
    module_size=$(cat /sys/module/kvmfr/parameters/static_size_mb 2>/dev/null || echo "0")
    if [[ "$module_size" != "$IVSHMEM_SIZE" ]]; then
      echo "Module loaded with wrong size (${module_size}MB, expected ${IVSHMEM_SIZE}MB) - reloading..."
      sudo -n rmmod kvmfr 2>/dev/null || true
      if sudo -n modprobe kvmfr static_size_mb="$IVSHMEM_SIZE" 2>/dev/null; then
        udevadm settle --timeout=5 2>/dev/null || sleep 1
        msg_success "Module reloaded with ${IVSHMEM_SIZE}MB"
      else
        msg_warning "Module reload failed (reboot required)"
      fi
    else
      msg_success "Module already loaded (${IVSHMEM_SIZE}MB)"
    fi
  fi
else
  if sudo -n modprobe kvmfr static_size_mb="$IVSHMEM_SIZE" 2>/dev/null; then
    # Wait for udev to create /dev/kvmfr0
    udevadm settle --timeout=5 2>/dev/null || sleep 1
    msg_success "Module loaded"
  else
    msg_warning "Module load failed"
    # Check if Secure Boot might be the cause
    if command -v mokutil &>/dev/null; then
      if mokutil --sb-state 2>/dev/null | grep -qi "enabled"; then
        echo "   Secure Boot is enabled - this may block unsigned modules!"
        echo "   Either disable Secure Boot in BIOS or sign the module."
      else
        echo "   Try rebooting, or check: dmesg | grep -i kvmfr"
      fi
    else
      echo "   Try rebooting, or check: dmesg | grep -i kvmfr"
    fi
  fi
fi

# Check device readability (kvm group membership may need re-login)
if [[ -e /dev/kvmfr0 ]] && [[ ! -r /dev/kvmfr0 ]]; then
  msg_warning "Device /dev/kvmfr0 exists but not readable by $USER"
  echo "  This will be fixed after re-login or reboot (kvm group membership)"
fi

echo ""
echo "Installation complete!"
echo ""
echo "Capture toggle key: $(format_escape_key_name "$ESCAPE_KEY")"
echo "  To change, edit: ~/.config/looking-glass/client.ini"
echo "  Set escapeKey= to: KEY_SCROLLLOCK, KEY_RIGHTCTRL, KEY_RIGHTALT, KEY_PAUSE, KEY_INSERT"
echo ""

NEEDS_REBOOT=false
REBOOT_REASONS=""

if ! lsmod | grep -q kvmfr || [[ ! -e /dev/kvmfr0 ]]; then
  NEEDS_REBOOT=true
  REBOOT_REASONS="  - Kernel module not active"$'\n'"$REBOOT_REASONS"
fi

if [[ "$NEEDS_REBOOT" == true ]]; then
  msg_warning "Reboot required for:"
  echo "$REBOOT_REASONS"
  echo ""
  echo "After reboot, enable Looking Glass during Windows VM installation:"
  echo "   omarchy-windows-vm install"
  echo ""
else
  msg_success "Looking Glass client ready!"
  echo ""
  echo "Next step: Install Windows VM with Looking Glass support"
  echo "   omarchy-windows-vm install"
  echo "   (Select 'Yes' when asked about Looking Glass)"
  echo ""
fi
